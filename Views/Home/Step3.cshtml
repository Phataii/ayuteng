@model ayuteng.Models.Application

@{
    ViewData["Title"] = "Problem & Solution";
    ViewData["CurrentStep"] = 3;
    ViewData["StepTitle"] = "Problem & Solution";
    ViewData["CompletedSteps"] = new List<int> { 1, 2 };
    ViewData["Previous"] = ViewBag.Previous;
}

<div class="step-form">
    <div class="section-header">
        <h2>Problem & Solution</h2>
        <p class="form-subtitle">Describe the problem you're solving and your innovative solution.</p>
    </div>

    <form id="step3Form" method="post">
        <div class="section-card">
            <h3 class="section-title">
                <span class="section-icon">ðŸŽ¯</span>
                Farmer Challenges
            </h3>
            <div class="form-group">
                <label for="FarmerChallenges" class="form-label required">
                    What are the key challenges faced by farmers that your solution addresses?
                    <span class="field-info">Describe specific problems in detail</span>
                </label>
                <textarea name="FarmerChallenges" id="FarmerChallenges" class="form-control textarea" rows="5"
                    placeholder="Describe the main challenges faced by farmers that your startup aims to solve..."
                    maxlength="2000" required>@Model?.FarmerChallenges</textarea>
                <div class="textarea-counter">
                    <span id="FarmerChallengesCounter">@(Model?.FarmerChallenges?.Length ?? 0)</span>/2000 characters
                </div>
                <span class="validation-error" id="FarmerChallengesError"></span>
            </div>
        </div>

        <div class="section-card">
            <h3 class="section-title">
                <span class="section-icon">ðŸ’¡</span>
                Your Solution
            </h3>
            <div class="form-group">
                <label for="SolutionDescription" class="form-label required">
                    How does your solution address these challenges?
                    <span class="field-info">Explain your product/service and how it solves the problem</span>
                </label>
                <textarea name="SolutionDescription" id="SolutionDescription" class="form-control textarea" rows="5"
                    placeholder="Describe your solution, technology, or approach to solving the identified challenges..."
                    maxlength="2000" required>@Model?.SolutionDescription</textarea>
                <div class="textarea-counter">
                    <span id="SolutionDescriptionCounter">@(Model?.SolutionDescription?.Length ?? 0)</span>/2000
                    characters
                </div>
                <span class="validation-error" id="SolutionDescriptionError"></span>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="ProductStage" class="form-label required">
                        Product Stage
                        <span class="field-info">Current development stage of your solution</span>
                    </label>
                    <select name="ProductStage" id="ProductStage" class="form-control" required>
                        <option value="">Select stage</option>
                        <option value="Idea" selected="@(Model?.ProductStage == "Idea")">Idea/Concept</option>
                        <option value="Prototype" selected="@(Model?.ProductStage == "Prototype")">Prototype</option>
                        <option value="MVP" selected="@(Model?.ProductStage == "MVP")">Minimum Viable Product (MVP)
                        </option>
                        <option value="Pilot" selected="@(Model?.ProductStage == "Pilot")">Pilot Testing</option>
                        <option value="Launched" selected="@(Model?.ProductStage == "Launched")">Launched & Scaling
                        </option>
                        <option value="Mature" selected="@(Model?.ProductStage == "Mature")">Mature Product</option>
                    </select>
                    <span class="validation-error" id="ProductStageError"></span>
                </div>

                <div class="form-group">
                    <label for="ProductLink" class="form-label">
                        Product Link
                        <span class="field-info">Website, app store link, or demo video</span>
                    </label>
                    <input name="ProductLink" id="ProductLink" type="url" class="form-control"
                        placeholder="https://example.com/product" value="@Model?.ProductLink">
                    <span class="validation-error" id="ProductLinkError"></span>
                </div>
            </div>

            <div class="form-group">
                <label for="InnovationHighlight" class="form-label required">
                    What makes your solution innovative?
                    <span class="field-info">Highlight your unique technology, approach, or differentiation</span>
                </label>
                <textarea name="InnovationHighlight" id="InnovationHighlight" class="form-control textarea" rows="4"
                    placeholder="Explain what makes your solution unique, novel, or particularly effective..."
                    maxlength="1500" required>@Model?.InnovationHighlight</textarea>
                <div class="textarea-counter">
                    <span id="InnovationHighlightCounter">@(Model?.InnovationHighlight?.Length ?? 0)</span>/1500
                    characters
                </div>
                <span class="validation-error" id="InnovationHighlightError"></span>
            </div>
        </div>

        <div class="section-card">
            <h3 class="section-title">
                <span class="section-icon">ðŸ‘¥</span>
                Users & Adoption
            </h3>
            <div class="form-group">
                <label for="PrimaryUsers" class="form-label required">
                    Who are your primary users/customers?
                    <span class="field-info">Describe your target audience (e.g., smallholder farmers, cooperatives,
                        agribusinesses)</span>
                </label>
                <textarea name="PrimaryUsers" id="PrimaryUsers" class="form-control textarea" rows="3"
                    placeholder="Describe your target users, their characteristics, and why they need your solution..."
                    maxlength="1000" required>@Model?.PrimaryUsers</textarea>
                <div class="textarea-counter">
                    <span id="PrimaryUsersCounter">@(Model?.PrimaryUsers?.Length ?? 0)</span>/1000 characters
                </div>
                <span class="validation-error" id="PrimaryUsersError"></span>
            </div>

            <div class="form-group">
                <label for="NoOfActiveUsers" class="form-label required">
                    Number of Active Users
                    <span class="field-info">How many users are actively using your solution?</span>
                </label>
                <input name="NoOfActiveUsers" id="NoOfActiveUsers" type="number" class="form-control" min="0"
                    max="10000000" placeholder="Enter number" value="@Model?.NoOfActiveUsers" required>
                <span class="validation-error" id="NoOfActiveUsersError"></span>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-submit" id="submitBtn">
                Save & Continue â†’
            </button>
        </div>
    </form>
</div>

<style>
    /* Step 3 Specific Styles */
    .step-form {
        max-width: 800px;
        margin: 0 auto;
    }

    h2 {
        color: var(--primary-blue);
        margin-bottom: 8px;
        font-size: 28px;
        font-weight: 700;
    }

    .form-subtitle {
        color: var(--gray);
        margin-bottom: 30px;
        font-size: 16px;
        line-height: 1.5;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    @@media (min-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr 1fr;
        }

        .full-width {
            grid-column: 1 / -1;
        }
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--primary-blue);
        font-size: 14px;
    }

    .form-label.required::after {
        content: ' *';
        color: var(--error-color);
    }

    .field-info {
        display: block;
        font-weight: normal;
        font-size: 12px;
        color: var(--gray);
        margin-top: 2px;
    }

    .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--input-border);
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: var(--white);
        color: var(--primary-blue);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-green);
        box-shadow: 0 0 0 3px rgba(57, 179, 74, 0.1);
    }

    .form-control::placeholder {
        color: #a0a0a0;
    }

    /* Step 3 Specific Styles */
    .section-header {
        margin-bottom: 30px;
    }

    .section-card {
        background: var(--white);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid var(--input-border);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .section-title {
        color: var(--primary-blue);
        margin-bottom: 20px;
        font-size: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-icon {
        font-size: 24px;
    }

    .textarea {
        resize: vertical;
        min-height: 100px;
        font-family: inherit;
        line-height: 1.5;
    }

    .textarea-counter {
        text-align: right;
        font-size: 12px;
        color: var(--gray);
        margin-top: 4px;
    }

    .textarea-counter.warning {
        color: #F59E0B;
    }

    .textarea-counter.danger {
        color: var(--error-color);
    }

    /* Select Styling */
    select.form-control {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%235D6D7E' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 16px center;
        padding-right: 40px;
        cursor: pointer;
    }

    /* Validation Styles */
    .validation-error {
        display: block;
        color: var(--error-color);
        font-size: 12px;
        margin-top: 6px;
        min-height: 18px;
    }

    .form-control.input-validation-error {
        border-color: var(--error-color);
    }

    .form-control.input-validation-error:focus {
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }

    /* Form Actions */
    .form-actions {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid var(--input-border);
    }

    .btn-submit {
        width: 100%;
        padding: 16px;
        font-size: 16px;
        font-weight: 600;
    }

    /* Mobile Optimizations */
    @@media (max-width: 767px) {
        h2 {
            font-size: 24px;
        }

        .form-subtitle {
            font-size: 15px;
        }

        .form-control {
            padding: 14px 16px;
            font-size: 16px;
        }

        .section-card {
            padding: 20px;
        }
    }

    /* Loading State */
    .btn-submit.loading {
        position: relative;
        color: transparent;
    }

    .btn-submit.loading::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease infinite;
    }

    @@keyframes spin {
        to {
            transform: translate(-50%, -50%) rotate(360deg);
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('step3Form');
        const submitBtn = document.getElementById('submitBtn');

        // Extract application ID from current URL
        const currentUrl = window.location.pathname;
        const urlSegments = currentUrl.split('/');
        const applicationId = urlSegments[urlSegments.length - 1];

        // Validate it's a GUID
        const guidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

        if (!guidPattern.test(applicationId)) {
            console.error('Invalid application ID in URL:', applicationId);
            showAlert('Invalid application. Please start from step 1.');
            return;
        }

        // API endpoint with application ID
        const API_ENDPOINT = `/api/application/step-three/${applicationId}`;

        // Character counters
        const textareas = document.querySelectorAll('.textarea');
        textareas.forEach(textarea => {
            const counterId = textarea.id + 'Counter';
            const counter = document.getElementById(counterId);

            if (counter) {
                // Initialize counter
                counter.textContent = textarea.value.length;
                updateCounterStyle(counter, textarea.value.length, textarea.maxLength);

                // Update on input
                textarea.addEventListener('input', function () {
                    counter.textContent = this.value.length;
                    updateCounterStyle(counter, this.value.length, this.maxLength);
                });
            }
        });

        function updateCounterStyle(counter, length, maxLength) {
            const max = parseInt(maxLength) || 0;
            counter.classList.remove('warning', 'danger');

            if (length > max * 0.9) {
                counter.classList.add('danger');
            } else if (length > max * 0.75) {
                counter.classList.add('warning');
            }
        }

        // URL validation helper
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // Form submission via API
        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            // Clear previous errors
            clearErrors();

            // Client-side validation
            let isValid = true;

            // Validate URL if provided
            const productLink = document.getElementById('ProductLink');
            if (productLink.value.trim() && !isValidUrl(productLink.value)) {
                showFieldError('ProductLink', 'Please enter a valid URL');
                isValid = false;
            }

            // Validate text length limits
            const textareaIds = [
                'FarmerChallenges',
                'SolutionDescription',
                'InnovationHighlight',
                'PrimaryUsers'
            ];

            textareaIds.forEach(id => {
                const textarea = document.getElementById(id);
                const maxLength = parseInt(textarea.getAttribute('maxlength')) || 0;

                if (textarea.value.length > maxLength) {
                    showFieldError(id, `Cannot exceed ${maxLength} characters`);
                    isValid = false;
                }
            });

            // Validate number field
            const usersField = document.getElementById('NoOfActiveUsers');
            if (usersField.value) {
                const users = parseInt(usersField.value);
                if (isNaN(users) || users < 0) {
                    showFieldError('NoOfActiveUsers', 'Please enter a valid positive number');
                    isValid = false;
                }
            }

            if (!isValid) {
                return;
            }

            // Show loading state
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;

            try {
                // Prepare form data
                const data = {
                    FarmerChallenges: document.getElementById('FarmerChallenges').value,
                    SolutionDescription: document.getElementById('SolutionDescription').value,
                    ProductStage: document.getElementById('ProductStage').value,
                    ProductLink: document.getElementById('ProductLink').value,
                    InnovationHighlight: document.getElementById('InnovationHighlight').value,
                    PrimaryUsers: document.getElementById('PrimaryUsers').value,
                    NoOfActiveUsers: document.getElementById('NoOfActiveUsers').value
                };


                // Submit to API with application ID in route
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Success - redirect to next step
                    if (result.redirectUrl) {
                        window.location.href = result.redirectUrl;
                    } else {
                        // Default redirect to step 4
                        window.location.href = `/application/step-four/${applicationId}`;
                    }
                } else {
                    // Handle validation errors from server
                    if (result.errors) {
                        displayServerErrors(result.errors);
                    } else {
                        throw new Error(result.message || 'Submission failed');
                    }
                }

            } catch (error) {
                console.error('Submission error:', error);
                showAlert(error.message || 'An error occurred. Please try again.');
            } finally {
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
            }
        });

        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');

            if (field) {
                field.classList.add('input-validation-error');
            }

            if (errorElement) {
                errorElement.textContent = message;
            }
        }

        function clearErrors() {
            document.querySelectorAll('.validation-error').forEach(el => {
                el.textContent = '';
            });

            document.querySelectorAll('.form-control').forEach(el => {
                el.classList.remove('input-validation-error');
            });
        }

        function displayServerErrors(errors) {
            clearErrors();

            Object.keys(errors).forEach(fieldName => {
                const field = document.getElementById(fieldName);
                const errorElement = document.getElementById(fieldName + 'Error');

                if (field && errorElement) {
                    field.classList.add('input-validation-error');
                    errorElement.textContent = errors[fieldName].join(', ');

                    if (Object.keys(errors)[0] === fieldName) {
                        field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            });
        }

        function showAlert(message) {
            alert(message);
        }

        // Real-time validation
        const inputs = form.querySelectorAll('.form-control');
        inputs.forEach(input => {
            input.addEventListener('input', function () {
                this.classList.remove('input-validation-error');
                const errorElement = document.getElementById(this.id + 'Error');
                if (errorElement) errorElement.textContent = '';
            });
        });

        // Load existing data if this page was loaded with data
        loadExistingData();

        async function loadExistingData() {
            try {
                // This would be called if you have a GET endpoint to load data
                // const response = await fetch(`/api/application/step-three/${applicationId}`);
                // const result = await response.json();
                // if (result.success && result.data) {
                //     // Populate form fields
                // }
            } catch (error) {
                console.error('Error loading existing data:', error);
            }
        }
    });
</script>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
@model ayuteng.Models.Application

@{
    ViewData["Title"] = "Business Model";
    ViewData["CurrentStep"] = 4;
    ViewData["StepTitle"] = "Business Model";
    ViewData["CompletedSteps"] = new List<int> { 1, 2, 3 };
}

<div class="step-form">
    <div class="section-header">
        <h2>Business Model</h2>
        <p class="form-subtitle">Describe how your business works and generates revenue.</p>
    </div>

    <form id="step4Form" method="post">

        <div class="section-card">
            <h3 class="section-title">
                <span class="section-icon">ðŸ’°</span>
                Revenue Model
            </h3>
            <div class="form-group">
                <label for="BusinessModel" class="form-label required">
                    Describe your business model
                    <span class="field-info">How do you make money? (e.g., subscription, transaction fees, marketplace,
                        licensing)</span>
                </label>
                <textarea name="BusinessModel" id="BusinessModel" class="form-control textarea" rows="4"
                    placeholder="Explain your revenue streams, pricing strategy, and business model..." maxlength="1500"
                    required>@Model?.BusinessModel</textarea>
                <div class="textarea-counter">
                    <span id="BusinessModelCounter">@(Model?.BusinessModel?.Length ?? 0)</span>/1500 characters
                </div>
                <span class="validation-error" id="BusinessModelError"></span>
            </div>

            <div class="form-group">
                <div class="toggle-group">
                    <label class="form-label">Are you currently generating revenue?</label>
                    <div class="toggle-switch">
                        <input name="IsRevenueGeneration" id="IsRevenueGeneration" type="checkbox"
                            class="toggle-checkbox" @(Model?.IsRevenueGeneration == true ? "checked" : "")>
                        <label for="IsRevenueGeneration" class="toggle-label">
                            <span class="toggle-text">No</span>
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">Yes</span>
                        </label>
                    </div>
                </div>
                <span class="validation-error" id="IsRevenueGenerationError"></span>
            </div>

            <div class="form-group">
                <label for="GoToMarketStrategy" class="form-label required">
                    Go-to-Market Strategy
                    <span class="field-info">How do you acquire and retain customers?</span>
                </label>
                <textarea name="GoToMarketStrategy" id="GoToMarketStrategy" class="form-control textarea" rows="4"
                    placeholder="Describe your marketing, sales, and customer acquisition strategy..." maxlength="1500"
                    required>@Model?.GoToMarketStrategy</textarea>
                <div class="textarea-counter">
                    <span id="GoToMarketStrategyCounter">@(Model?.GoToMarketStrategy?.Length ?? 0)</span>/1500
                    characters
                </div>
                <span class="validation-error" id="GoToMarketStrategyError"></span>
            </div>
        </div>

        <div class="section-card">
            <h3 class="section-title">
                <span class="section-icon">ðŸ“Š</span>
                Customer Metrics
            </h3>
            <div class="form-grid">
                <div class="form-group">
                    <label for="NoOfCustomers" class="form-label required">
                        Number of Paying Customers
                        <span class="field-info">Total paying customers (if applicable)</span>
                    </label>
                    <input name="NoOfCustomers" id="NoOfCustomers" type="number" class="form-control" min="0"
                        max="10000000" placeholder="0" value="@Model?.NoOfCustomers" required>
                    <span class="validation-error" id="NoOfCustomersError"></span>
                </div>

                <div class="form-group">
                    <label for="AverageCac" class="form-label">
                        Average Customer Acquisition Cost (CAC)
                        <span class="field-info">In USD (if known)</span>
                    </label>
                    <div class="input-with-prefix">
                        <span class="input-prefix">$</span>
                        <input name="AverageCac" id="AverageCac" type="number" class="form-control" min="0"
                            max="1000000" step="0.01" placeholder="0.00" value="@Model?.AverageCac">
                    </div>
                    <span class="validation-error" id="AverageCacError"></span>
                </div>
            </div>
        </div>

        <div class="section-card">
            <h3 class="section-title">
                <span class="section-icon">ðŸ¥Š</span>
                Competition
            </h3>
            <div class="form-group">
                <label for="Competitors" class="form-label">
                    Who are your main competitors?
                    <span class="field-info">And what makes you better/different?</span>
                </label>
                <textarea name="Competitors" id="Competitors" class="form-control textarea" rows="4"
                    placeholder="List your main competitors and explain your competitive advantage..."
                    maxlength="1500">@Model?.Competitors</textarea>
                <div class="textarea-counter">
                    <span id="CompetitorsCounter">@(Model?.Competitors?.Length ?? 0)</span>/1500 characters
                </div>
                <span class="validation-error" id="CompetitorsError"></span>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-submit" id="submitBtn">
                Save & Continue â†’
            </button>
        </div>
    </form>
</div>

<style>
    /* Step 4 Specific Styles */
    .step-form {
        max-width: 800px;
        margin: 0 auto;
    }

    h2 {
        color: var(--primary-blue);
        margin-bottom: 8px;
        font-size: 28px;
        font-weight: 700;
    }

    .form-subtitle {
        color: var(--gray);
        margin-bottom: 30px;
        font-size: 16px;
        line-height: 1.5;
    }

    .form-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    @@media (min-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr 1fr;
        }

        .full-width {
            grid-column: 1 / -1;
        }
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--primary-blue);
        font-size: 14px;
    }

    .form-label.required::after {
        content: ' *';
        color: var(--error-color);
    }

    .field-info {
        display: block;
        font-weight: normal;
        font-size: 12px;
        color: var(--gray);
        margin-top: 2px;
    }

    .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--input-border);
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: var(--white);
        color: var(--primary-blue);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary-green);
        box-shadow: 0 0 0 3px rgba(57, 179, 74, 0.1);
    }

    .form-control::placeholder {
        color: #a0a0a0;
    }

    .input-with-prefix {
        position: relative;
    }

    .input-prefix {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray);
        font-weight: 500;
    }

    .input-with-prefix .form-control {
        padding-left: 30px;
    }

    /* Step 4 Specific Styles */
    .section-header {
        margin-bottom: 30px;
    }

    .section-card {
        background: var(--white);
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        border: 1px solid var(--input-border);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .section-title {
        color: var(--primary-blue);
        margin-bottom: 20px;
        font-size: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-icon {
        font-size: 24px;
    }

    .textarea {
        resize: vertical;
        min-height: 100px;
        font-family: inherit;
        line-height: 1.5;
    }

    .textarea-counter {
        text-align: right;
        font-size: 12px;
        color: var(--gray);
        margin-top: 4px;
    }

    .textarea-counter.warning {
        color: #F59E0B;
    }

    .textarea-counter.danger {
        color: var(--error-color);
    }

    /* Toggle Switch */
    .toggle-group {
        margin: 15px 0;
    }

    .toggle-switch {
        display: flex;
        align-items: center;
        gap: 15px;
        margin: 10px 0;
    }

    .toggle-checkbox {
        display: none;
    }

    .toggle-label {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
    }

    .toggle-slider {
        position: relative;
        width: 60px;
        height: 30px;
        background: var(--gray);
        border-radius: 30px;
        transition: all 0.3s ease;
    }

    .toggle-slider::before {
        content: '';
        position: absolute;
        width: 26px;
        height: 26px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: all 0.3s ease;
    }

    .toggle-checkbox:checked+.toggle-label .toggle-slider {
        background: var(--primary-green);
    }

    .toggle-checkbox:checked+.toggle-label .toggle-slider::before {
        transform: translateX(30px);
    }

    .toggle-text {
        font-weight: 600;
        font-size: 14px;
        color: var(--gray);
        min-width: 30px;
    }

    .toggle-checkbox:not(:checked)+.toggle-label .toggle-text:first-child {
        color: var(--primary-blue);
    }

    .toggle-checkbox:checked+.toggle-label .toggle-text:last-child {
        color: var(--primary-green);
    }

    /* Validation Styles */
    .validation-error {
        display: block;
        color: var(--error-color);
        font-size: 12px;
        margin-top: 6px;
        min-height: 18px;
    }

    .form-control.input-validation-error {
        border-color: var(--error-color);
    }

    .form-control.input-validation-error:focus {
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }

    /* Form Actions */
    .form-actions {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid var(--input-border);
    }

    .btn-submit {
        width: 100%;
        padding: 16px;
        font-size: 16px;
        font-weight: 600;
    }

    /* Mobile Optimizations */
    @@media (max-width: 767px) {
        h2 {
            font-size: 24px;
        }

        .form-subtitle {
            font-size: 15px;
        }

        .form-control {
            padding: 14px 16px;
            font-size: 16px;
        }

        .section-card {
            padding: 20px;
        }

        .toggle-switch {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
    }

    /* Loading State */
    .btn-submit.loading {
        position: relative;
        color: transparent;
    }

    .btn-submit.loading::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease infinite;
    }

    @@keyframes spin {
        to {
            transform: translate(-50%, -50%) rotate(360deg);
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('step4Form');
        const submitBtn = document.getElementById('submitBtn');

        // Extract application ID from current URL
        const currentUrl = window.location.pathname;
        const urlSegments = currentUrl.split('/');
        const applicationId = urlSegments[urlSegments.length - 1];

        // Validate it's a GUID
        const guidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

        if (!guidPattern.test(applicationId)) {
            console.error('Invalid application ID in URL:', applicationId);
            showAlert('Invalid application. Please start from step 1.');
            return;
        }

        // API endpoint with application ID
        const API_ENDPOINT = `/api/application/step-four/${applicationId}`;

        // Character counters
        const textareas = document.querySelectorAll('.textarea');
        textareas.forEach(textarea => {
            const counterId = textarea.id + 'Counter';
            const counter = document.getElementById(counterId);

            if (counter) {
                // Initialize counter
                counter.textContent = textarea.value.length;
                updateCounterStyle(counter, textarea.value.length, textarea.maxLength);

                // Update on input
                textarea.addEventListener('input', function () {
                    counter.textContent = this.value.length;
                    updateCounterStyle(counter, this.value.length, this.maxLength);
                });
            }
        });

        function updateCounterStyle(counter, length, maxLength) {
            const max = parseInt(maxLength) || 0;
            counter.classList.remove('warning', 'danger');

            if (length > max * 0.9) {
                counter.classList.add('danger');
            } else if (length > max * 0.75) {
                counter.classList.add('warning');
            }
        }

        // Form submission via API
        form.addEventListener('submit', async function (e) {
            e.preventDefault();

            // Clear previous errors
            clearErrors();

            // Client-side validation
            let isValid = true;

            // Validate text length limits
            const textareaIds = [
                'BusinessModel',
                'GoToMarketStrategy',
                'Competitors'
            ];

            textareaIds.forEach(id => {
                const textarea = document.getElementById(id);
                if (textarea) {
                    const maxLength = parseInt(textarea.getAttribute('maxlength')) || 0;

                    if (textarea.value.length > maxLength) {
                        showFieldError(id, `Cannot exceed ${maxLength} characters`);
                        isValid = false;
                    }
                }
            });

            // Validate number fields
            const numberFields = [
                { id: 'NoOfCustomers', name: 'Number of customers', min: 0 },
                { id: 'AverageCac', name: 'Average CAC', min: 0, optional: true }
            ];

            numberFields.forEach(field => {
                const input = document.getElementById(field.id);
                if (input && input.value) {
                    const value = parseFloat(input.value);

                    if (isNaN(value)) {
                        showFieldError(field.id, `Please enter a valid number for ${field.name}`);
                        isValid = false;
                    } else if (value < field.min) {
                        showFieldError(field.id, `${field.name} cannot be less than ${field.min}`);
                        isValid = false;
                    }
                } else if (!field.optional && (!input || !input.value.trim())) {
                    showFieldError(field.id, `${field.name} is required`);
                    isValid = false;
                }
            });

            if (!isValid) {
                return;
            }

            // Show loading state
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;

            try {
                // Prepare form data
                const data = {
                    BusinessModel: document.getElementById('BusinessModel').value,
                    IsRevenueGeneration: document.getElementById('IsRevenueGeneration').checked,
                    GoToMarketStrategy: document.getElementById('GoToMarketStrategy').value,
                    NoOfCustomers: document.getElementById('NoOfCustomers').value,
                    AverageCac: document.getElementById('AverageCac').value,
                    Competitors: document.getElementById('Competitors').value
                };

                // Submit to API with application ID in route
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Success - redirect to next step
                    if (result.redirectUrl) {
                        window.location.href = result.redirectUrl;
                    } else {
                        // Default redirect to step 5
                        window.location.href = `/application/step-five/${applicationId}`;
                    }
                } else {
                    // Handle validation errors from server
                    if (result.errors) {
                        displayServerErrors(result.errors);
                    } else {
                        throw new Error(result.message || 'Submission failed');
                    }
                }

            } catch (error) {
                console.error('Submission error:', error);
                showAlert(error.message || 'An error occurred. Please try again.');
            } finally {
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
            }
        });

        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorElement = document.getElementById(fieldId + 'Error');

            if (field) {
                field.classList.add('input-validation-error');
            }

            if (errorElement) {
                errorElement.textContent = message;
            }
        }

        function clearErrors() {
            document.querySelectorAll('.validation-error').forEach(el => {
                el.textContent = '';
            });

            document.querySelectorAll('.form-control').forEach(el => {
                el.classList.remove('input-validation-error');
            });
        }

        function displayServerErrors(errors) {
            clearErrors();

            Object.keys(errors).forEach(fieldName => {
                const field = document.getElementById(fieldName);
                const errorElement = document.getElementById(fieldName + 'Error');

                if (field && errorElement) {
                    field.classList.add('input-validation-error');
                    errorElement.textContent = errors[fieldName].join(', ');

                    if (Object.keys(errors)[0] === fieldName) {
                        field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            });
        }

        function showAlert(message) {
            alert(message);
        }

        // Real-time validation
        const inputs = form.querySelectorAll('.form-control');
        inputs.forEach(input => {
            input.addEventListener('input', function () {
                this.classList.remove('input-validation-error');
                const errorElement = document.getElementById(this.id + 'Error');
                if (errorElement) errorElement.textContent = '';
            });
        });

        // Number input formatting for CAC
        const cacInput = document.getElementById('AverageCac');
        if (cacInput) {
            cacInput.addEventListener('blur', function () {
                if (this.value) {
                    const value = parseFloat(this.value);
                    if (!isNaN(value)) {
                        this.value = value.toFixed(2);
                    }
                }
            });
        }

        // Load existing data if this page was loaded with data
        loadExistingData();

        async function loadExistingData() {
            try {
                // This would be called if you have a GET endpoint to load data
                // const response = await fetch(`/api/application/step-four/${applicationId}`);
                // const result = await response.json();
                // if (result.success && result.data) {
                //     // Populate form fields
                // }
            } catch (error) {
                console.error('Error loading existing data:', error);
            }
        }
    });
</script>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}